<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GITRIS WebSocket Test Client</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .game-section {
            flex: 2;
            display: flex;
            gap: 20px;
        }
        .player-area {
            flex: 1;
            border: 2px solid #333;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        .controls {
            flex: 1;
            border: 2px solid #333;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
        }
        .tetris-board {
            display: grid;
            grid-template-columns: repeat(10, 25px);
            grid-template-rows: repeat(20, 25px);
            gap: 1px;
            background: #000;
            padding: 5px;
            margin: 10px auto;
            border: 3px solid #444;
            border-radius: 5px;
            max-width: fit-content;
        }
        .cell {
            width: 25px;
            height: 25px;
            background: #111;
            border: 1px solid #333;
        }
        
        /* „ÉÜ„Éà„É™„Éü„Éé„ÅÆËâ≤ */
        .cell.type-0 { background: #4ecdc4; } /* I - „Ç∑„Ç¢„É≥ */
        .cell.type-1 { background: #feca57; } /* O - ÈªÑ */
        .cell.type-2 { background: #9b59b6; } /* T - Á¥´ */
        .cell.type-3 { background: #2ecc71; } /* S - Á∑ë */
        .cell.type-4 { background: #e74c3c; } /* Z - Ëµ§ */
        .cell.type-5 { background: #3498db; } /* J - Èùí */
        .cell.type-6 { background: #f39c12; } /* L - „Ç™„É¨„É≥„Ç∏ */
        .cell.type-7 { background: #95a5a6; } /* Filled - „Ç∞„É¨„Éº */
        .cell.type-8 { background: #7f8c8d; } /* Garbage - „ÉÄ„Éº„ÇØ„Ç∞„É¨„Éº */
        
        /* „Çπ„Ç≥„Ç¢„Éô„Éº„Çπ„ÅÆËâ≤Âº∑Â∫¶ */
        .cell.score-low { filter: brightness(0.6); }      /* 100-199: Êöó„ÇÅ */
        .cell.score-medium { filter: brightness(0.8); }   /* 200-299: Ê®ôÊ∫ñ„Çà„ÇäÂ∞ë„ÅóÊöó„ÇÅ */
        .cell.score-high { filter: brightness(1.0); }     /* 300-399: Ê®ôÊ∫ñ */
        .cell.score-very-high { 
            filter: brightness(1.3) saturate(1.2); 
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.5);
        } /* 400-499: Êòé„Çã„ÅèÂÖâ„Çã */
        
        .cell.current {
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
            border: 2px solid #fff;
            animation: pulse 1s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 5px rgba(255, 255, 255, 0.6); }
            100% { box-shadow: 0 0 12px rgba(255, 255, 255, 0.9); }
        }
        
        .status {
            margin: 10px 0;
            padding: 15px;
            background: #333;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status h3 {
            margin: 0 0 10px 0;
            color: #007bff;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #444;
        }
        .status-label {
            font-weight: bold;
        }
        .status-value {
            color: #4ecdc4;
        }
        
        .game-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .info-box {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .info-box .label {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }
        .info-box .value {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .log {
            height: 200px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            font-size: 11px;
            border-radius: 5px;
            border: 1px solid #333;
        }
        button {
            margin: 5px;
            padding: 10px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        input {
            padding: 10px;
            margin: 5px;
            border: 1px solid #555;
            border-radius: 5px;
            background: #333;
            color: #fff;
            width: calc(100% - 20px);
        }
        input::placeholder {
            color: #999;
        }
        
        .control-section {
            margin: 20px 0;
            padding: 15px;
            background: #333;
            border-radius: 8px;
        }
        .control-section h3 {
            margin: 0 0 15px 0;
            color: #4ecdc4;
            border-bottom: 2px solid #4ecdc4;
            padding-bottom: 5px;
        }
        
        .game-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .game-controls button {
            padding: 15px;
            font-size: 14px;
        }
        
        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 12px;
        }
        .status-connected { background: #28a745; color: white; }
        .status-disconnected { background: #dc3545; color: white; }
        .status-connecting { background: #ffc107; color: black; }
        
        h1 {
            text-align: center;
            color: #4ecdc4;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 30px;
        }
        h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .player-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .player1-title { color: #ff6b6b; }
        .player2-title { color: #4ecdc4; }
        
        .next-piece, .hold-piece {
            margin: 10px 0;
            text-align: center;
        }
        .next-piece h4, .hold-piece h4 {
            margin: 5px 0;
            color: #999;
            font-size: 12px;
        }
        .mini-board {
            display: grid;
            grid-template-columns: repeat(4, 15px);
            grid-template-rows: repeat(4, 15px);
            gap: 1px;
            background: #000;
            padding: 3px;
            margin: 5px auto;
            border: 1px solid #444;
            max-width: fit-content;
        }
        .mini-cell {
            width: 15px;
            height: 15px;
            background: #111;
        }
        
        .score-info {
            margin: 10px 0;
            text-align: center;
        }
        .score-info h4 {
            margin: 5px 0;
            color: #999;
            font-size: 12px;
        }
        .score-legend {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .score-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: #ccc;
        }
        .score-demo {
            width: 12px;
            height: 12px;
            background: #4ecdc4; /* „Éá„Éï„Ç©„É´„ÉàËâ≤ */
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <h1>üéÆ GITRIS - WebSocket Test Client üéÆ</h1>
    
    <div class="container">
        <div class="game-section">
            <!-- „Éó„É¨„Ç§„É§„Éº1„Ç®„É™„Ç¢ -->
            <div class="player-area">
                <div class="player-title player1-title">üë§ Player 1</div>
                
                <div class="status">
                    <h3>„Ç≤„Éº„É†Áä∂ÊÖã</h3>
                    <div class="status-item">
                        <span class="status-label">Êé•Á∂ö:</span>
                        <span class="connection-status status-disconnected" id="connectionStatus">Êú™Êé•Á∂ö</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ÂêàË®ÄËëâ:</span>
                        <span class="status-value" id="passcodeStatus">Êú™Ë®≠ÂÆö</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">„Ç≤„Éº„É†:</span>
                        <span class="status-value" id="gameStatus">ÂæÖÊ©ü‰∏≠</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Player 1:</span>
                        <span class="status-value" id="player1Status">Êú™ÂèÇÂä†</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Player 2:</span>
                        <span class="status-value" id="player2Status">Êú™ÂèÇÂä†</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Âà∂ÈôêÊôÇÈñì:</span>
                        <span class="status-value" id="timeLimit">--</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ÊÆã„ÇäÊôÇÈñì:</span>
                        <span class="status-value" id="remainingTime">--</span>
                    </div>
                </div>
                
                <div class="tetris-board" id="player1Board"></div>
                
                <div class="game-info">
                    <div class="info-box">
                        <div class="label">„Çπ„Ç≥„Ç¢</div>
                        <div class="value" id="player1Score">0</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„É¨„Éô„É´</div>
                        <div class="value" id="player1Level">1</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„É©„Ç§„É≥</div>
                        <div class="value" id="player1Lines">0</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</div>
                        <div class="value" id="player1GameOver">-</div>
                    </div>
                    <div class="info-box">
                        <div class="label">‰∫àÊÉ≥„Çπ„Ç≥„Ç¢</div>
                        <div class="value" id="player1PieceScore">-</div>
                    </div>
                </div>
                
                <div class="next-piece">
                    <h4>Next</h4>
                    <div class="mini-board" id="player1Next"></div>
                </div>
                
                <div class="hold-piece">
                    <h4>Hold</h4>
                    <div class="mini-board" id="player1Hold"></div>
                </div>
                
                <div class="score-info">
                    <h4>„Çπ„Ç≥„Ç¢„Ç¨„Ç§„Éâ</h4>
                    <div class="score-legend">
                        <div class="score-item">
                            <div class="score-demo score-low"></div>
                            <span>100-199pt (‰Ωé)</span>
                        </div>
                        <div class="score-item">
                            <div class="score-demo score-medium"></div>
                            <span>200-299pt (‰∏≠)</span>
                        </div>
                        <div class="score-item">
                            <div class="score-demo score-high"></div>
                            <span>300-399pt (È´ò)</span>
                        </div>
                        <div class="score-item">
                            <div class="score-demo score-very-high"></div>
                            <span>400-499pt (ÊúÄÈ´ò)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- „Éó„É¨„Ç§„É§„Éº2„Ç®„É™„Ç¢ -->
            <div class="player-area">
                <div class="player-title player2-title">üë§ Player 2</div>
                
                <div class="tetris-board" id="player2Board"></div>
                
                <div class="game-info">
                    <div class="info-box">
                        <div class="label">„Çπ„Ç≥„Ç¢</div>
                        <div class="value" id="player2Score">0</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„É¨„Éô„É´</div>
                        <div class="value" id="player2Level">1</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„É©„Ç§„É≥</div>
                        <div class="value" id="player2Lines">0</div>
                    </div>
                    <div class="info-box">
                        <div class="label">„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</div>
                        <div class="value" id="player2GameOver">-</div>
                    </div>
                    <div class="info-box">
                        <div class="label">‰∫àÊÉ≥„Çπ„Ç≥„Ç¢</div>
                        <div class="value" id="player2PieceScore">-</div>
                    </div>
                </div>
                
                <div class="next-piece">
                    <h4>Next</h4>
                    <div class="mini-board" id="player2Next"></div>
                </div>
                
                <div class="hold-piece">
                    <h4>Hold</h4>
                    <div class="mini-board" id="player2Hold"></div>
                </div>
            </div>
        </div>
        
        <!-- „Ç≥„É≥„Éà„É≠„Éº„É´„Éë„Éç„É´ -->
        <div class="controls">
            <h2>üéõÔ∏è „Ç≥„É≥„Éà„É≠„Éº„É´</h2>
            
            <div class="control-section">
                <h3>üîå Êé•Á∂öË®≠ÂÆö</h3>
                <input type="text" id="serverUrl" value="ws://localhost:8080" placeholder="WebSocket URL">
                <input type="text" id="passcode" placeholder="ÂêàË®ÄËëâÔºà3-20ÊñáÂ≠óÔºâ" maxlength="20" minlength="3">
                <input type="text" id="userId" placeholder="„É¶„Éº„Ç∂„ÉºID">
                <input type="text" id="authToken" placeholder="Ë™çË®º„Éà„Éº„ÇØ„É≥ (Bearer ...)" style="width: calc(100% - 20px);">
                <button onclick="connectWebSocket()">üîó WebSocketÊé•Á∂ö</button>
                <button onclick="disconnect()">‚ùå ÂàáÊñ≠</button>
            </div>
            
            <div class="control-section">
                <h3>üéÆ „Ç≤„Éº„É†Êìç‰Ωú</h3>
                                 <div class="game-controls">
                     <button onclick="sendAction('move_left')">‚¨ÖÔ∏è Â∑¶ÁßªÂãï</button>
                     <button onclick="sendAction('move_right')">‚û°Ô∏è Âè≥ÁßªÂãï</button>
                     <button onclick="sendAction('rotate')">üîÑ ÂõûËª¢</button>
                     <button onclick="sendAction('soft_drop')">‚¨áÔ∏è „ÇΩ„Éï„Éà</button>
                     <button onclick="sendAction('hard_drop')">‚ö° „Éè„Éº„Éâ</button>
                     <button onclick="sendAction('hold')">üì¶ „Éõ„Éº„É´„Éâ</button>
                 </div>
                 <div style="margin-top: 10px; font-size: 12px; color: #999;">
                     „Ç≠„Éº„Éú„Éº„Éâ: ‚Üê‚ÜíÁßªÂãï ‚Üë„Éè„Éº„Éâ ‚Üì„ÇΩ„Éï„Éà / Space=ÂõûËª¢ / C=„Éõ„Éº„É´„Éâ
                 </div>
            </div>
            
            <div class="control-section">
                <h3>üéØ ÂêàË®ÄËëâ„Éû„ÉÉ„ÉÅ„É≥„Ç∞</h3>
                <div style="margin-bottom: 10px; font-size: 14px; color: #ccc;">
                    üéØ <strong>ÂêàË®ÄËëâ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅÆÊµÅ„ÇåÔºö</strong><br>
                    1Ô∏è‚É£ ÂêàË®ÄËëâ„ÇíÊ±∫„ÇÅ„Å¶„ÄåÂêàË®ÄËëâ„ÅßÂÖ•ÂÆ§„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ<br>
                    2Ô∏è‚É£ „ÄåWebSocketÊé•Á∂ö„Äç„ÅßÂØæÊà¶„É´„Éº„É†„Å´Êé•Á∂ö<br>
                    3Ô∏è‚É£ Âêå„ÅòÂêàË®ÄËëâ„ÅÆÁõ∏Êâã„ÅåÊù•„Åü„ÇâËá™Âãï„Åß„Ç≤„Éº„É†ÈñãÂßãÔºÅ
                </div>
                <button onclick="joinByPasscode()">üöÄ ÂêàË®ÄËëâ„ÅßÂÖ•ÂÆ§</button>
                <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    ‚ÄªÂêàË®ÄËëâ„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä20ÊñáÂ≠ó‰ª•‰∏ã„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
                    ‚Äª‰æãÔºö„Äå„ÉÜ„Éà„É™„Çπ„Äç„ÄåÂØæÊà¶„Äç„ÄåÂèãÈÅî„Äç„Å™„Å©
                </div>
            </div>
            

            
            <div class="control-section">
                <h3>üìã „É≠„Ç∞</h3>
                <div class="log" id="log"></div>
                <button onclick="clearLog()">üóëÔ∏è „É≠„Ç∞„ÇØ„É™„Ç¢</button>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let gameState = null;
        
        // „É≠„Ç∞Âá∫Âäõ
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = 'connection-status';
            
            switch(status) {
                case 'connected':
                    statusElement.textContent = 'Êé•Á∂öÊ∏à„Åø';
                    statusElement.classList.add('status-connected');
                    break;
                case 'connecting':
                    statusElement.textContent = 'Êé•Á∂ö‰∏≠';
                    statusElement.classList.add('status-connecting');
                    break;
                case 'disconnected':
                default:
                    statusElement.textContent = 'Êú™Êé•Á∂ö';
                    statusElement.classList.add('status-disconnected');
                    break;
            }
        }
        
        // WebSocketÊé•Á∂ö
        function connectWebSocket() {
            const passcode = document.getElementById('passcode').value;
            const userId = document.getElementById('userId').value;
            
            if (!passcode) {
                alert('ÂêàË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (passcode.length < 3 || passcode.length > 20) {
                alert('ÂêàË®ÄËëâ„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä20ÊñáÂ≠ó‰ª•‰∏ã„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (!userId) {
                alert('„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            const wsUrl = `ws://localhost:8080/api/game/ws/${passcode}`;
            log(`WebSocketÊé•Á∂ö„ÇíË©¶Ë°å‰∏≠: ${wsUrl}`);
            updateConnectionStatus('connecting');
            
            socket = new WebSocket(wsUrl);
            
            socket.onopen = function(event) {
                log('WebSocketÊé•Á∂ö„ÅåÈñã„Åã„Çå„Åæ„Åó„Åü');
                updateConnectionStatus('connected');
                
                // ÂêàË®ÄËëâ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                document.getElementById('passcodeStatus').textContent = passcode;
                
                // Ë™çË®º„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°
                const authMessage = {
                    type: 'auth',
                    token: document.getElementById('authToken').value
                };
                socket.send(JSON.stringify(authMessage));
                log('Ë™çË®º„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
            };
            
            socket.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    
                    // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂøúÁ≠î„ÅÆÁ®ÆÈ°û„ÇíÂà§ÂÆö
                    if (data.type) {
                        // type „Éï„Ç£„Éº„É´„Éâ„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºàË™çË®ºÂøúÁ≠î„Å™„Å©Ôºâ
                        if (data.type === 'auth_success') {
                            log('Ë™çË®º„ÅåÊàêÂäü„Åó„Åæ„Åó„Åü');
                        } else {
                            handleGameMessage(data);
                        }
                    } else if (data.id && (data.player1 || data.player2)) {
                        // GameSession„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÂ†¥Âêà
                        updateGameState(data);
                    } else {
                        log(`Êú™Áü•„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏ÂΩ¢Âºè: ${JSON.stringify(data).substring(0, 100)}...`);
                    }
                } catch (error) {
                    log(`„É°„ÉÉ„Çª„Éº„Ç∏Ëß£Êûê„Ç®„É©„Éº: ${error.message}`);
                }
            };
            
            socket.onerror = function(event) {
                log(`WebSocket„Ç®„É©„Éº: ${event}`);
                updateConnectionStatus('disconnected');
            };
            
            socket.onclose = function(event) {
                log(`WebSocketÊé•Á∂ö„ÅåÈñâ„Åò„Çâ„Çå„Åæ„Åó„Åü: ${event.code} - ${event.reason}`);
                socket = null;
                updateConnectionStatus('disconnected');
                document.getElementById('passcodeStatus').textContent = 'Êú™Ë®≠ÂÆö';
            };
        }
        
        function disconnect() {
            if (socket) {
                socket.close();
                socket = null;
            }
        }
        
        // „Éú„Éº„Éâ„Ç≠„É£„ÉÉ„Ç∑„É• - „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑ„ÅÆ„Åü„ÇÅ
        const boardCache = {};
        
        // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„ÅüËâ≤„ÇØ„É©„Çπ„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        function getScoreClass(score) {
            if (score >= 400) return 'score-very-high';
            if (score >= 300) return 'score-high';
            if (score >= 200) return 'score-medium';
            return 'score-low';
        }
        
        // ÁèæÂú®„ÅÆ„Éî„Éº„Çπ„ÅÆ‰∫àÊÉ≥„Çπ„Ç≥„Ç¢„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
        function calculatePieceScore(currentPiece, contributionScores) {
            if (!currentPiece || !contributionScores || 
                typeof currentPiece.x !== 'number' || 
                typeof currentPiece.y !== 'number' || 
                typeof currentPiece.type !== 'number') {
                return 0;
            }
            
            const pieceBlocks = getPieceBlocks(currentPiece.type, currentPiece.rotation || 0);
            let totalScore = 0;
            let blockCount = 0;
            
            for (const block of pieceBlocks) {
                const boardRow = currentPiece.y + block[1];
                const boardCol = currentPiece.x + block[0];
                
                if (boardRow >= 0 && boardRow < 20 && boardCol >= 0 && boardCol < 10) {
                    const scoreKey = `${boardRow}_${boardCol}`;
                    const score = contributionScores[scoreKey];
                    if (score !== undefined) {
                        totalScore += score;
                        blockCount++;
                    }
                }
            }
            
            return blockCount > 0 ? Math.round(totalScore) : 0;
        }
        
        // „ÉÜ„Éà„É™„Çπ„Éú„Éº„Éâ„ÅÆÊèèÁîªÔºà„Çπ„Ç≥„Ç¢„Éô„Éº„ÇπËâ≤ÂàÜ„ÅëÂØæÂøúÁâàÔºâ
        function drawTetrisBoard(boardId, boardData, currentPiece = null, contributionScores = null, currentPieceScores = null) {
            const boardElement = document.getElementById(boardId);
            if (!boardElement) return;
            
            // „Éú„Éº„Éâ„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøDOM„Çí‰ΩúÊàê
            if (!boardCache[boardId]) {
                boardElement.innerHTML = '';
                boardCache[boardId] = { cells: [], lastUpdate: null };
                
                // 20Ë°å x 10Âàó„ÅÆ„Çª„É´„Çí‰ΩúÊàê
                for (let row = 0; row < 20; row++) {
                    boardCache[boardId].cells[row] = [];
                    for (let col = 0; col < 10; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'cell';
                        boardCache[boardId].cells[row][col] = cell;
                        boardElement.appendChild(cell);
                    }
                }
            }
            
            const cells = boardCache[boardId].cells;
            
            // ÂÖ®„Çª„É´„Çí„É™„Çª„ÉÉ„ÉàÔºàÂäπÁéáÁöÑ„Å´Ôºâ
            for (let row = 0; row < 20; row++) {
                for (let col = 0; col < 10; col++) {
                    cells[row][col].className = 'cell';
                }
            }
            
            // „Éú„Éº„Éâ„Éá„Éº„Çø„ÇíÈÅ©Áî®Ôºà„Çπ„Ç≥„Ç¢„Éô„Éº„Çπ„ÅÆËâ≤ÂàÜ„Åë„ÇÇÂê´„ÇÄÔºâ
            if (boardData && Array.isArray(boardData)) {
                for (let row = 0; row < Math.min(20, boardData.length); row++) {
                    if (Array.isArray(boardData[row])) {
                        for (let col = 0; col < Math.min(10, boardData[row].length); col++) {
                            const cellValue = boardData[row][col];
                            if (cellValue && cellValue > 0) {
                                // BlockType (1-7) „Çí PieceType (0-6) „Å´Â§âÊèõ
                                cells[row][col].classList.add(`type-${cellValue - 1}`);
                                
                                // „Çπ„Ç≥„Ç¢„Éô„Éº„Çπ„ÅÆËâ≤ÂàÜ„Åë„ÇíÈÅ©Áî®
                                if (contributionScores) {
                                    const scoreKey = `${row}_${col}`;
                                    const score = contributionScores[scoreKey];
                                    if (score !== undefined) {
                                        cells[row][col].classList.add(getScoreClass(score));
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            // ÁèæÂú®„ÅÆ„Éî„Éº„Çπ„ÇíÊèèÁîªÔºà„Çπ„Ç≥„Ç¢„Éô„Éº„Çπ„ÅÆËâ≤ÂàÜ„Åë„ÇÇÂê´„ÇÄÔºâ
            if (currentPiece && typeof currentPiece.x === 'number' && typeof currentPiece.y === 'number' && typeof currentPiece.type === 'number') {
                const pieceBlocks = getPieceBlocks(currentPiece.type, currentPiece.rotation || 0);
                
                for (const block of pieceBlocks) {
                    const boardRow = currentPiece.y + block[1];
                    const boardCol = currentPiece.x + block[0];
                    
                    if (boardRow >= 0 && boardRow < 20 && boardCol >= 0 && boardCol < 10) {
                        cells[boardRow][boardCol].classList.add('current');
                        // PieceType (0-6) „Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                        cells[boardRow][boardCol].classList.add(`type-${currentPiece.type}`);
                        
                        // ÁèæÂú®„ÅÆ„Éî„Éº„Çπ„Å´„ÅØÂ∞ÇÁî®„ÅÆ„Çπ„Ç≥„Ç¢„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºà„Çà„ÇäÊ≠£Á¢∫Ôºâ
                        if (currentPieceScores) {
                            const scoreKey = `${boardRow}_${boardCol}`;
                            const score = currentPieceScores[scoreKey];
                            if (score !== undefined) {
                                cells[boardRow][boardCol].classList.add(getScoreClass(score));
                            }
                        } else if (contributionScores) {
                            // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ÂæìÊù•„ÅÆcontributionScores„Çí‰ΩøÁî®
                            const scoreKey = `${boardRow}_${boardCol}`;
                            const score = contributionScores[scoreKey];
                            if (score !== undefined) {
                                cells[boardRow][boardCol].classList.add(getScoreClass(score));
                            }
                        }
                    }
                }
            }
        }
        
        // „ÉÜ„Éà„É™„Éü„Éé„ÅÆÂΩ¢Áä∂„Éá„Éº„Çø„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        function getPieceBlocks(pieceType, rotation) {
            const pieceShapes = {
                0: [ // TypeI
                    [[0, 1], [1, 1], [2, 1], [3, 1]], // 0Â∫¶ (Ê®™)
                    [[2, 0], [2, 1], [2, 2], [2, 3]], // 90Â∫¶ (Á∏¶)
                    [[0, 2], [1, 2], [2, 2], [3, 2]], // 180Â∫¶ (Ê®™)
                    [[1, 0], [1, 1], [1, 2], [1, 3]], // 270Â∫¶ (Á∏¶)
                ],
                1: [ // TypeO
                    [[0, 0], [1, 0], [0, 1], [1, 1]], // ÂÖ®„Å¶„ÅÆÂõûËª¢„ÅßÂêå„Åò
                ],
                2: [ // TypeT
                    [[1, 0], [0, 1], [1, 1], [2, 1]], // 0Â∫¶
                    [[1, 0], [1, 1], [2, 1], [1, 2]], // 90Â∫¶
                    [[0, 1], [1, 1], [2, 1], [1, 2]], // 180Â∫¶
                    [[0, 1], [1, 0], [1, 1], [1, 2]], // 270Â∫¶
                ],
                3: [ // TypeS
                    [[1, 0], [2, 0], [0, 1], [1, 1]], // 0Â∫¶
                    [[1, 0], [1, 1], [2, 1], [2, 2]], // 90Â∫¶
                    [[1, 1], [2, 1], [0, 2], [1, 2]], // 180Â∫¶
                    [[0, 0], [0, 1], [1, 1], [1, 2]], // 270Â∫¶
                ],
                4: [ // TypeZ
                    [[0, 0], [1, 0], [1, 1], [2, 1]], // 0Â∫¶
                    [[2, 0], [1, 1], [2, 1], [1, 2]], // 90Â∫¶
                    [[0, 1], [1, 1], [1, 2], [2, 2]], // 180Â∫¶
                    [[1, 0], [0, 1], [1, 1], [0, 2]], // 270Â∫¶
                ],
                5: [ // TypeJ
                    [[0, 0], [0, 1], [1, 1], [2, 1]], // 0Â∫¶
                    [[1, 0], [2, 0], [1, 1], [1, 2]], // 90Â∫¶
                    [[0, 1], [1, 1], [2, 1], [2, 2]], // 180Â∫¶
                    [[1, 0], [1, 1], [0, 2], [1, 2]], // 270Â∫¶
                ],
                6: [ // TypeL
                    [[2, 0], [0, 1], [1, 1], [2, 1]], // 0Â∫¶
                    [[1, 0], [1, 1], [1, 2], [2, 2]], // 90Â∫¶
                    [[0, 1], [1, 1], [2, 1], [0, 2]], // 180Â∫¶
                    [[0, 0], [1, 0], [1, 1], [1, 2]], // 270Â∫¶
                ],
            };
            
            const shapes = pieceShapes[pieceType];
            if (!shapes) {
                log(`Unknown piece type: ${pieceType}`);
                return [];
            }
            
            // O„Éü„Éé„ÅØÂõûËª¢„Åó„Å™„ÅÑ
            if (pieceType === 1) {
                return shapes[0];
            }
            
            const rotIdx = Math.floor((rotation || 0) / 90) % 4;
            return shapes[rotIdx] || shapes[0];
        }
        
        // „Éü„Éã„Éú„Éº„Éâ„Ç≠„É£„ÉÉ„Ç∑„É•
        const miniBoardCache = {};
        
        // „Éü„Éã„Éú„Éº„ÉâÔºàNext/HoldÔºâ„ÅÆÊèèÁîªÔºàÊúÄÈÅ©ÂåñÁâàÔºâ
        function drawMiniBoard(boardId, pieceData) {
            const boardElement = document.getElementById(boardId);
            if (!boardElement) return;
            
            // „Éú„Éº„Éâ„ÅåÂàùÊúüÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøDOM„Çí‰ΩúÊàê
            if (!miniBoardCache[boardId]) {
                boardElement.innerHTML = '';
                miniBoardCache[boardId] = { cells: [], lastPieceType: null };
                
                // 4x4„ÅÆ„Çª„É´„Çí‰ΩúÊàê
                for (let row = 0; row < 4; row++) {
                    miniBoardCache[boardId].cells[row] = [];
                    for (let col = 0; col < 4; col++) {
                        const cell = document.createElement('div');
                        cell.className = 'mini-cell';
                        miniBoardCache[boardId].cells[row][col] = cell;
                        boardElement.appendChild(cell);
                    }
                }
            }
            
            const cells = miniBoardCache[boardId].cells;
            const cache = miniBoardCache[boardId];
            
            // „Éî„Éº„Çπ„Çø„Ç§„Éó„ÅåÂ§â„Çè„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÊõ¥Êñ∞
            const pieceType = pieceData ? pieceData.type : null;
            if (cache.lastPieceType === pieceType) {
                return; // Â§âÊõ¥„Å™„Åó„Å™„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó
            }
            cache.lastPieceType = pieceType;
            
            // ÂÖ®„Çª„É´„Çí„É™„Çª„ÉÉ„Éà
            for (let row = 0; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    cells[row][col].className = 'mini-cell';
                }
            }
            
            // „Éî„Éº„Çπ„Éá„Éº„Çø„ÇíÈÅ©Áî®
            if (pieceData && typeof pieceData.type === 'number') {
                const pieceBlocks = getPieceBlocks(pieceData.type, 0); // „Éü„Éã„Éú„Éº„Éâ„ÅØÂ∏∏„Å´0Â∫¶ÂõûËª¢„ÅßË°®Á§∫
                
                if (pieceBlocks.length > 0) {
                    // „Éî„Éº„Çπ„Çí‰∏≠Â§ÆÂØÑ„Åõ„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç™„Éï„Çª„ÉÉ„ÉàË®àÁÆó
                    let minX = Math.min(...pieceBlocks.map(b => b[0]));
                    let minY = Math.min(...pieceBlocks.map(b => b[1]));
                    let maxX = Math.max(...pieceBlocks.map(b => b[0]));
                    let maxY = Math.max(...pieceBlocks.map(b => b[1]));
                    
                    const pieceWidth = maxX - minX + 1;
                    const pieceHeight = maxY - minY + 1;
                    const offsetX = Math.floor((4 - pieceWidth) / 2) - minX;
                    const offsetY = Math.floor((4 - pieceHeight) / 2) - minY;
                    
                    for (const block of pieceBlocks) {
                        const row = block[1] + offsetY;
                        const col = block[0] + offsetX;
                        
                        if (row >= 0 && row < 4 && col >= 0 && col < 4) {
                            // PieceType (0-6) „Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
                            cells[row][col].classList.add(`type-${pieceData.type}`);
                        }
                    }
                }
            }
        }
        
        // „Ç¢„ÇØ„Ç∑„Éß„É≥ÈÄÅ‰ø°
        function sendAction(action) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                log('WebSocket„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
                return;
            }
            
            const message = {
                action: action
            };
            
            socket.send(JSON.stringify(message));
            log(`ÈÄÅ‰ø°: ${JSON.stringify(message)}`);
        }
        
        // „Éá„ÉÉ„Ç≠ID„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
        async function getDeckId() {
            const authToken = document.getElementById('authToken').value;
            const userId = document.getElementById('userId').value;
            
            if (!authToken || !userId) {
                log('Ë™çË®º„Éà„Éº„ÇØ„É≥„Å®„É¶„Éº„Ç∂„ÉºID„ÅåÂøÖË¶Å„Åß„Åô');
                return null;
            }
            
            // Ë™çË®º„Éà„Éº„ÇØ„É≥„Å´Bearer„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Åå‰ªò„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
            let authHeader = authToken;
            if (!authToken.startsWith('Bearer ')) {
                authHeader = `Bearer ${authToken}`;
            }
            
            try {
                const response = await fetch(`/api/protected/deck/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': authHeader
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`„Éá„ÉÉ„Ç≠ÂèñÂæó„Ç®„É©„Éº: ${response.status}`);
                }
                
                const data = await response.json();
                log(`„Éá„ÉÉ„Ç≠ÂèñÂæóÁµêÊûú: ${JSON.stringify(data)}`);
                
                if (data && data.deck && data.deck.id) {
                    return data.deck.id;
                } else {
                    log('„Éá„ÉÉ„Ç≠ID„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return null;
                }
            } catch (error) {
                log(`„Éá„ÉÉ„Ç≠ÂèñÂæó„Ç®„É©„Éº: ${error.message}`);
                return null;
            }
        }
        

        
        // ÂêàË®ÄËëâ„Åß„É´„Éº„É†„Å´ÂèÇÂä†
        async function joinByPasscode() {
            const passcode = document.getElementById('passcode').value;
            const userId = document.getElementById('userId').value;
            const authToken = document.getElementById('authToken').value;

            if (!passcode) {
                alert('ÂêàË®ÄËëâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            if (passcode.length < 3 || passcode.length > 20) {
                alert('ÂêàË®ÄËëâ„ÅØ3ÊñáÂ≠ó‰ª•‰∏ä20ÊñáÂ≠ó‰ª•‰∏ã„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!userId) {
                alert('„É¶„Éº„Ç∂„ÉºID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            if (!authToken) {
                alert('Ë™çË®º„Éà„Éº„ÇØ„É≥„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            // „Åæ„Åö„Éá„ÉÉ„Ç≠ID„ÇíÂèñÂæó
            const deckId = await getDeckId();
            if (!deckId) {
                log('„Éá„ÉÉ„Ç≠ID„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                return;
            }

            // Ë™çË®º„Éà„Éº„ÇØ„É≥„Å´Bearer„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Åå‰ªò„ÅÑ„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
            let authHeader = authToken;
            if (!authToken.startsWith('Bearer ')) {
                authHeader = `Bearer ${authToken}`;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': authHeader
            };

            fetch(`/api/game/room/passcode/${passcode}/join`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    deck_id: deckId
                })
            })
            .then(response => response.json())
                         .then(data => {
                 log(`ÂêàË®ÄËëâ„Åß„ÅÆ„É´„Éº„É†ÂèÇÂä†ÁµêÊûú: ${JSON.stringify(data)}`);
                 if (data.success) {
                     log('ÂêàË®ÄËëâ„Åß„ÅÆ„Éû„ÉÉ„ÉÅ„É≥„Ç∞„ÅåÊàêÂäü„Åó„Åæ„Åó„ÅüÔºÅWebSocket„Å´Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                     // ÂêàË®ÄËëâ„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                     document.getElementById('passcodeStatus').textContent = `${passcode} (Ê∫ñÂÇôÂÆå‰∫Ü)`;
                 }
             })
            .catch(error => {
                log(`ÂêàË®ÄËëâ„Åß„ÅÆ„É´„Éº„É†ÂèÇÂä†„Ç®„É©„Éº: ${error.message}`);
            });
        }
        
        // „Ç≤„Éº„É†„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÂá¶ÁêÜ
        function handleGameMessage(data) {
            switch(data.type) {
                case 'game_state':
                    updateGameState(data);
                    break;
                case 'room_status':
                    updateRoomStatus(data);
                    break;
                case 'error':
                    log(`„Ç®„É©„Éº: ${data.message}`);
                    break;
                default:
                    log(`Êú™ÂØæÂøú„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„Çø„Ç§„Éó: ${data.type}`);
            }
        }
        
        // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆ„Ç≠„É£„ÉÉ„Ç∑„É•ÔºàÈáçË§áÊõ¥Êñ∞„ÇíÈÅø„Åë„Çã„Åü„ÇÅÔºâ
        let lastGameStateUpdate = 0;
        
        // „Ç≤„Éº„É†Áä∂ÊÖã„ÅÆÊõ¥Êñ∞Ôºà„Åï„Çâ„Å´ËªΩÈáèÂåñÔºâ
        function updateGameState(data) {
            // Êõ¥Êñ∞È†ªÂ∫¶„ÇíÂà∂ÈôêÔºà10fpsÂà∂Èôê - Áõ∏Êâã„ÅÆÂãï„Åç„ÅØ1Áßí„Åä„Åç„Å™„ÅÆ„ÅßÂçÅÂàÜÔºâ
            const now = Date.now();
            if (now - lastGameStateUpdate < 100) { // Á¥Ñ10fps
                return;
            }
            lastGameStateUpdate = now;
            
            gameState = data;
            
            // „Ç≤„Éº„É†„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞
            const gameStatus = data.status || '‰∏çÊòé';
            document.getElementById('gameStatus').textContent = gameStatus;
            
            // ÊôÇÈñìÂà∂Èôê„ÅÆË°®Á§∫Êõ¥Êñ∞
            if (data.time_limit) {
                document.getElementById('timeLimit').textContent = `${data.time_limit}Áßí`;
            }
            
            // ÊÆã„ÇäÊôÇÈñì„ÅÆË°®Á§∫Êõ¥Êñ∞Ôºà„Ç≤„Éº„É†‰∏≠„ÅÆ„ÅøÔºâ
            if (data.remaining_time !== undefined && gameStatus === 'playing') {
                const remainingTime = Math.max(0, data.remaining_time);
                document.getElementById('remainingTime').textContent = `${remainingTime}Áßí`;
                
                // ÊÆã„ÇäÊôÇÈñì„ÅåÂ∞ë„Å™„ÅÑÂ†¥Âêà„ÅØË≠¶ÂëäËâ≤„Å´„Åô„Çã
                const remainingElement = document.getElementById('remainingTime');
                if (remainingTime <= 3) {
                    remainingElement.style.color = '#e74c3c'; // Ëµ§
                    remainingElement.style.fontWeight = 'bold';
                } else if (remainingTime <= 5) {
                    remainingElement.style.color = '#f39c12'; // „Ç™„É¨„É≥„Ç∏
                    remainingElement.style.fontWeight = 'bold';
                } else {
                    remainingElement.style.color = '#4ecdc4'; // ÈÄöÂ∏∏„ÅÆËâ≤
                    remainingElement.style.fontWeight = 'normal';
                }
            } else {
                document.getElementById('remainingTime').textContent = '--';
                document.getElementById('remainingTime').style.color = '#4ecdc4';
                document.getElementById('remainingTime').style.fontWeight = 'normal';
            }
            
            // „Éó„É¨„Ç§„É§„Éº1„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            if (data.player1) {
                const player1Status = `ÂèÇÂä†Ê∏à„Åø (ID: ${data.player1.user_id || 'N/A'})`;
                document.getElementById('player1Status').textContent = player1Status;
                
                // „Éó„É¨„Ç§„É§„Éº1„ÅÆ„Ç≤„Éº„É†ÊÉÖÂ†±Êõ¥Êñ∞
                document.getElementById('player1Score').textContent = data.player1.score || 0;
                document.getElementById('player1Level').textContent = data.player1.level || 1;
                document.getElementById('player1Lines').textContent = data.player1.lines_cleared || 0;
                document.getElementById('player1GameOver').textContent = data.player1.is_game_over ? 'YES' : 'NO';
                
                // „Éó„É¨„Ç§„É§„Éº1„ÅÆ„Éú„Éº„ÉâÊèèÁîªÔºà„Çπ„Ç≥„Ç¢ÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ
                drawTetrisBoard('player1Board', data.player1.board, data.player1.current_piece, data.player1.contribution_scores, data.player1.current_piece_scores);
                
                // ‰∫àÊÉ≥„Çπ„Ç≥„Ç¢Ë®àÁÆó„ÉªË°®Á§∫
                const player1PieceScore = calculatePieceScore(data.player1.current_piece, data.player1.contribution_scores);
                document.getElementById('player1PieceScore').textContent = player1PieceScore > 0 ? player1PieceScore : '-';
                
                // Next/Hold„Éî„Éº„ÇπÊèèÁîª
                drawMiniBoard('player1Next', data.player1.next_piece);
                drawMiniBoard('player1Hold', data.player1.held_piece);
            } else {
                document.getElementById('player1Status').textContent = 'Êú™ÂèÇÂä†';
            }
            
            // „Éó„É¨„Ç§„É§„Éº2„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            if (data.player2) {
                const player2Status = `ÂèÇÂä†Ê∏à„Åø (ID: ${data.player2.user_id || 'N/A'})`;
                document.getElementById('player2Status').textContent = player2Status;
                
                // „Éó„É¨„Ç§„É§„Éº2„ÅÆ„Ç≤„Éº„É†ÊÉÖÂ†±Êõ¥Êñ∞
                document.getElementById('player2Score').textContent = data.player2.score || 0;
                document.getElementById('player2Level').textContent = data.player2.level || 1;
                document.getElementById('player2Lines').textContent = data.player2.lines_cleared || 0;
                document.getElementById('player2GameOver').textContent = data.player2.is_game_over ? 'YES' : 'NO';
                
                // „Éó„É¨„Ç§„É§„Éº2„ÅÆ„Éú„Éº„ÉâÊèèÁîªÔºà„Çπ„Ç≥„Ç¢ÊÉÖÂ†±„ÇÇÂê´„ÇÄÔºâ
                drawTetrisBoard('player2Board', data.player2.board, data.player2.current_piece, data.player2.contribution_scores, data.player2.current_piece_scores);
                
                // ‰∫àÊÉ≥„Çπ„Ç≥„Ç¢Ë®àÁÆó„ÉªË°®Á§∫
                const player2PieceScore = calculatePieceScore(data.player2.current_piece, data.player2.contribution_scores);
                document.getElementById('player2PieceScore').textContent = player2PieceScore > 0 ? player2PieceScore : '-';
                
                // Next/Hold„Éî„Éº„ÇπÊèèÁîª
                drawMiniBoard('player2Next', data.player2.next_piece);
                drawMiniBoard('player2Hold', data.player2.held_piece);
            } else {
                document.getElementById('player2Status').textContent = 'Êú™ÂèÇÂä†';
            }
            
            // „Ç≤„Éº„É†ÁµÇ‰∫ÜÁä∂ÊÖã„ÅÆÁâπÂà•„Å™Âá¶ÁêÜ
            if (gameStatus === 'finished') {
                // „Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„ÅÆÂãùÊïóÂà§ÂÆö
                let endMessage = 'üèÅ „Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅ';
                
                if (data.player1 && data.player2) {
                    if (data.player1.is_game_over && !data.player2.is_game_over) {
                        endMessage = `üèÜ Player 2 (${data.player2.user_id}) „ÅÆÂãùÂà©ÔºÅ`;
                    } else if (!data.player1.is_game_over && data.player2.is_game_over) {
                        endMessage = `üèÜ Player 1 (${data.player1.user_id}) „ÅÆÂãùÂà©ÔºÅ`;
                    } else if (data.remaining_time === 0) {
                        // ÊôÇÈñìÂàá„Çå„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≥„Ç¢„ÅßÂà§ÂÆö
                        const score1 = data.player1.score || 0;
                        const score2 = data.player2.score || 0;
                        if (score1 > score2) {
                            endMessage = `‚è∞ ÊôÇÈñìÂàá„ÇåÔºÅ Player 1 (${data.player1.user_id}) „ÅÆÂãùÂà©ÔºÅ (${score1} vs ${score2})`;
                        } else if (score2 > score1) {
                            endMessage = `‚è∞ ÊôÇÈñìÂàá„ÇåÔºÅ Player 2 (${data.player2.user_id}) „ÅÆÂãùÂà©ÔºÅ (${score2} vs ${score1})`;
                        } else {
                            endMessage = `‚è∞ ÊôÇÈñìÂàá„ÇåÔºÅ Âºï„ÅçÂàÜ„ÅëÔºÅ (${score1} vs ${score2})`;
                        }
                    } else {
                        endMessage = 'üèÅ „Ç≤„Éº„É†ÁµÇ‰∫Ü (Âºï„ÅçÂàÜ„Åë)';
                    }
                }
                
                log(endMessage);
                
                // „Ç≤„Éº„É†ÁµÇ‰∫ÜÊôÇ„Å´„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫Ôºà‰ªªÊÑèÔºâ
                setTimeout(() => {
                    alert(endMessage);
                }, 500);
            }
            
            // „Ç≤„Éº„É†Áä∂ÊÖãÂ§âÊõ¥„ÅÆ„Åø„É≠„Ç∞„Å´Ë®òÈå≤
            log(`Game Status: ${gameStatus} | P1: ${data.player1 ? 'OK' : 'NO'} | P2: ${data.player2 ? 'OK' : 'NO'}`);
        }
        
        // „É´„Éº„É†Áä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateRoomStatus(data) {
            if (data.player1) {
                document.getElementById('player1Status').textContent = 'ÂèÇÂä†Ê∏à„Åø';
            }
            if (data.player2) {
                document.getElementById('player2Status').textContent = 'ÂèÇÂä†Ê∏à„Åø';
            }
        }
        
        // „Ç≠„Éº„Éú„Éº„ÉâÊìç‰Ωú
        document.addEventListener('keydown', function(event) {
            if (!socket || socket.readyState !== WebSocket.OPEN) return;
            
            switch(event.key) {
                case 'ArrowLeft':
                    event.preventDefault();
                    sendAction('move_left');
                    break;
                case 'ArrowRight':
                    event.preventDefault();
                    sendAction('move_right');
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    sendAction('soft_drop');
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    sendAction('hard_drop');
                    break;
                case ' ':
                    event.preventDefault();
                    sendAction('rotate');
                    break;
                case 'c':
                case 'C':
                    event.preventDefault();
                    sendAction('hold');
                    break;
            }
        });
        
        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            log('üéÆ GITRIS WebSocket Test Client „ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü');
            
            // „Éú„Éº„Éâ„ÇíÈÅÖÂª∂ÂàùÊúüÂåñÔºà„Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊîπÂñÑÔºâ
            setTimeout(() => {
                drawTetrisBoard('player1Board', []);
                drawTetrisBoard('player2Board', []);
                
                // „Éü„Éã„Éú„Éº„Éâ„ÇÇÂàùÊúüÂåñ
                drawMiniBoard('player1Next', null);
                drawMiniBoard('player1Hold', null);
                drawMiniBoard('player2Next', null);
                drawMiniBoard('player2Hold', null);
            }, 100);
            
            updateConnectionStatus('disconnected');
        });
    </script>
</body>
</html> 